WITH NotHaveJR(UserName,QuestionGroupId) AS (SELECT UserName, QuestionGroupId FROM Exam_JudgeRecoard AS JR WHERE ExamQuestionId IN ({0}) AND StudentId = @StudentId) UPDATE rtu SET ExamCount=ExamCount+1 FROM Exam_ReviewTask AS rtu WHERE EXISTS (SELECT ReviewTaskId FROM (SELECT ReviewTaskId, QuestionGroupId, ROW_NUMBER() over(partition BY QuestionGroupId ORDER BY newid() DESC) AS N FROM (SELECT DISTINCT ReviewTaskId, RT.QuestionGroupId FROM Exam_ReviewTask AS RT INNER JOIN NotHaveJR ON RT.QuestionGroupId = NotHaveJR.QuestionGroupId AND RT.UserName!=NotHaveJR.UserName WHERE NOT EXISTS (SELECT 1 FROM NotHaveJR WHERE NotHaveJR.QuestionGroupId = RT.QuestionGroupId AND RT.UserName = NotHaveJR.UserName)) AS T) AS T2 WHERE N =1 AND T2.ReviewTaskId = rtu.ReviewTaskId)